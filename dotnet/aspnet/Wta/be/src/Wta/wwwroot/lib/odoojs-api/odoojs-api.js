class e{constructor(e,s={}){const{api:i}=s;this._api=i;const n=Object.keys(e).filter((e=>"addons_models"!==e.slice(0,13))).reduce(((t,s)=>(t[s]=e[s],t)),{});this._addons_register=t.load_addons(n),this.api.debug&&console.log("_addons_register1",this._addons_register);const o=Object.keys(e).filter((e=>"addons_models"===e.slice(0,13))).reduce(((t,s)=>(t[s]=e[s],t)),{});this._addons_models_register=o,this.modules={}}get api(){return this._api}get addons_modules_installed(){const e=this.api.modules_installed;return[...e,...e.map((e=>`_${e}`)),...e.map((e=>`${e}_wizard`))]}load_all(){const e=this.addons_modules_installed,t=this._addons_register,s=Object.keys(t).filter((t=>e.includes(t))).reduce(((e,s)=>(e[s]=t[s],e)),{});this.modules=s}get views(){const e=this.modules;return Object.keys(e).reduce(((t,s)=>{const i=e[s];return{...t,...Object.keys(i).filter((e=>"ir.ui.view"===i[e]._odoo_model)).reduce(((e,t)=>{const n={...i[t]};return n.inherit_id&&2!==n.inherit_id.split(".").length&&(n.inherit_id=`${s}.${n.inherit_id}`),n.inherit_patch&&2!==n.inherit_patch.split(".").length&&(n.inherit_patch=`${s}.${n.inherit_patch}`),e[`${s}.${t}`]=n,e}),{})}}),{})}action_load(e){const[t,s]=e.split(".");if(!e)return{[t]:{}};if(!s)return{[t]:{}};const i=this.modules[t];if(!i)return{[t]:{}};const n=i[s];if(!n)return{[t]:{}};return{[t]:{[s]:{module:t,id:e,xml_id:e,...this._patch_views_for_action_load({module:t,...n})}}}}_patch_views_for_action_load(e){const{module:t,search_view_id:s,views:i}=e,n={...i,...s?{search:s}:{}};const o=Object.keys(n).reduce(((e,s)=>{const i=function(e,t){return 2==e.split(".").length?e:`${t}.${e}`}(n[s],t);return e[s]=i,e}),{}),r=this._get_views_for_inherit(o),{search:d,..._}=r;return{...e,views:_,...s?{search_view_id:d}:{}}}_get_views_for_inherit_patch(e){const t=this.views,s=Object.keys(t).filter((s=>t[s].inherit_patch===e)).reduce(((e,t)=>({...e,...this._get_views_for_inherit_patch(t)})),{});return{[e]:t[e],...s}}_merge_view(e,t){return{...Object.keys(e).reduce(((t,i)=>{const n=e[i],{buttons:o,inherit_id:r,priority:d,xml_id:_,...c}=n,l=s.merge_dict(t,{...c});return delete l.inherit_id,delete l.inherit_patch,l}),{}),xml_id:t,id:t}}_get_views_for_inherit_one(e){const t=this.views,s=Object.keys(t).filter((s=>t[e].inherit_id===s)).reduce(((e,t)=>{const s=this._get_views_for_inherit_one(t),i=this._get_views_for_inherit_patch(t);return{...s,[t]:{...this._merge_view(i,t)},...e}}),{}),i=this._get_views_for_inherit_patch(e),n=this._merge_view(i,e);return{...s,[e]:{...n}}}_get_views_for_inherit(e){return Object.keys(e).reduce(((t,s)=>{const i=e[s],n=this._get_views_for_inherit_one(i),o=this._merge_view(n,i);return t[s]={...o},t}),{})}_get_all_models_in_module(){const e=this._get_all_modules_with_models();return Object.keys(e).reduce(((t,s)=>{const i=e[s],n=Object.keys(i).reduce(((e,s)=>{const n=t[s]||{fields:{}};var o;return e[s]={fields:(n.fields,o=i[s].fields,o)},e}),{});return t={...t,...n}}),{})}_get_all_modules_with_models(){const e=this.modules;return Object.keys(e).reduce(((t,s)=>{const i=e[s];return{...t,...Object.keys(i).filter((e=>"model_"===e.slice(0,6))).reduce(((e,t)=>{const n=t,o={...i[t]},{fields:r}=o,d=e[s]||{};e[s]=d;const _=d[n]||{fields:{}};return e[s][n]=_,e[s][n].fields={...e[s][n].fields,...r},e}),{})}}),{})}get_all_menus(){const e=this.modules,t=Object.keys(e).reduce(((t,s)=>{const i=e[s];return{...t,...Object.keys(i).filter((e=>"ir.ui.menu"===i[e]._odoo_model)).reduce(((e,t)=>{const n={...i[t]};return n.parent&&2!==n.parent.split(".").length&&(n.parent=`${s}.${n.parent}`),e[`${s}.${t}`]=n,e}),{})}}),{});function s(e,t){const i=t.children||{};return Object.keys(i).reduce(((n,o)=>{const r=function(e,t,s){const i=`${e}.${t}`;return{...s,id:i,xml_id:i}}(e,o,i[o]);r.sequence="sequence"in r?r.sequence:10,r.parent=t.xml_id,r._odoo_model="ir.ui.menu";const d=s(e,r);return delete r.children,n[r.xml_id]=r,{...n,...d}}),{})}const i=Object.keys(t).reduce(((e,i)=>{const[n,o]=i.split("."),r=t[i],d={...r,sequence:"sequence"in r?r.sequence:10,xml_id:i,id:i},_=s(n,d);return delete d.children,e[d.xml_id]=d,{...e,..._}}),{});return Object.values(i).sort(((e,t)=>e.sequence-t.sequence)).filter((e=>!1!==e.active)).reduce(((e,t)=>(e[t.xml_id]={xml_id:t.xml_id,...t},e)),{})}}const t={load_addons_one(e,t){const s="addons_menus"===e.slice(0,12);return"function"!=typeof t?t:t.keys().reduce(((e,i)=>{const n=i.split("/");if("index.js"===n[n.length-1]);else{const o=function(e){if(s)return e[1].split(".")[0];return e[1]}(n),r=t(i).default||{},d=o;e[d]||(e[d]={}),e[d]={...e[d],...r}}return e}),{})},load_addons(e){return Object.keys(e).reduce(((t,s)=>{const i=e[s],n=this.load_addons_one(s,i),o=Object.keys({...t,...n});return t=o.reduce(((e,s)=>(e[s]={...t[s],...n[s]},e)),{})}),{})}},s={merge_dict(e,t){return function(){const s=Object.keys(e).reduce(((e,t,s)=>(e[t]=s+1,e)),{}),i=Object.keys(t).reduce(((e,t,s)=>(e[t]=s+1,e)),{}),n=Object.keys({...s,...i}).reduce(((e,t)=>{const n=s[t]||(()=>{const s=Object.keys(e).filter((s=>e[s][1]&&e[s][1]<i[t])).map((t=>e[t][0]));return s.length?Math.max(...s):0})(),o=i[t]||0;return e[t]=[n,o],e}),{}),o=Object.keys(n).map((e=>[e,...n[e]]));return o.sort(((e,t)=>e[1]-t[1])),o.map((e=>e[0]))}().reduce(((s,i)=>{const n=i in e,o=i in t,r=e[i],d=t[i];return n?o?"object"!=typeof d||Array.isArray(d)||"object"!=typeof r||Array.isArray(r)?s[i]=d:s[i]=this.merge_dict({...r},{...d}):s[i]=r:o&&(s[i]=d),s}),{})}};class i{constructor(t,s={}){const{addons_dict:i={},modules_installed:n=[]}=s,{lang:o="zh_CN",debug:r}=s;this.rpc=t,this.rpc.lang=o,this.rpc.debug=r,this.debug=r,this.addons=new e(i,{api:this,modules_installed:n}),t._addons_models=this.addons._addons_models_register,this.session_ok=!1,this.actions={},this._groups=[],this._modules_installed_in_odoo=[],this._modules_installed_in_web=n,this._menus={}}get baseURL(){return this.rpc.baseURL}get web(){return this.rpc.web}get env(){return this.rpc.env}get lang(){return this.rpc.lang}set lang(e){this.rpc.lang=e,this.reload_addons()}get modules_installed(){const e=this._modules_installed_in_odoo.map((e=>e.name));return this._modules_installed_in_web.length?this._modules_installed_in_web.filter((t=>e.includes(t))):e}get menus(){return this._menus}get menus_tree(){return function(e){const t=(s={})=>Object.values(e).filter((e=>s.xml_id?e.parent===s.xml_id:!e.parent)).map((e=>{const s=t(e);return{...e,children:s}})).filter((e=>Object.keys(e.children).length||e.action)).reduce(((e,t)=>(e[t.id]=t,e)),{});return t()}(this.menus)}reload_addons(){this.session_ok&&(this.addons.load_all(),this._menus=this.addons.get_all_menus())}async after_login_set_groups(){const e=this.env.uid,t=await this.env.model("res.users").read_one(e,["groups_id"]),s=(await this.env.model("ir.model.data").search_read({domain:[["res_id","in",t.groups_id],["model","=","res.groups"]],fields:["res_id","complete_name"]})).map((e=>({id:e.res_id,name:e.complete_name})));this.rpc._groups=s}async after_login_set_modules(){const e={name:{},dependencies_id:{fields:{name:{}}}},t=this.env.model("ir.module.module");await t.web2_fields_get(e);const s=await t.web2_search_read([["state","=","installed"]],e);this._modules_installed_in_odoo=s.records}async after_session(){await this.after_login_set_groups(),await this.after_login_set_modules(),this.session_ok=!0,this.reload_addons()}async login({db:e,login:t,password:s}){const i={db:e,login:t,password:s},n=await this.rpc.login(i);return n&&await this.after_session(),n}async session_check(){const e=await this.rpc.session_check();return e&&await this.after_session(),e}async logout(){return await this.rpc.logout()}action(e,t={}){if(!e)return;const s=this.addons.action_load(e),i=this.addons._get_all_models_in_module();return this.rpc.action(e,{models:i,actions:s,...t})}relation_node(e){const t=this.addons._get_all_models_in_module();return this.rpc.relation_node(e,{models:t})}check_all_addons(e=3){d=0,async function(e,t){console.log("check_all_addons");const s=e.addons._addons_register;for(const i in s)for(const n in s[i]){if("ir.actions.act_window"===s[i][n]._odoo_model){const s=`${i}.${n}`,o=e.action(s),_=o.fields;if(d+=1,d>t)return;await r(e.env,i,o.model,_)}}}(this,e)}}const n={api:null};function o(e,t){if(n.api)return n.api;{const s=new i(e,t);return n.api=s,s}}async function r(e,t,s,i){console.log("check_metadata1,  ",d,s);const n=e.model(s),o=Object.keys(i),_=await n._fields_get(o);for(const e in i)if(e in _);else{const t=n.metadata_extend||{};if(!(e in t))throw console.log("=== warning: wrong field=",s,e),console.log("warning,",i,_,t),"err  no field in model: "+s+"-"+e}for(const o in _){const d=_[o];if(d.relation){if("string"==typeof d.domain){const e=await n.web2_fields_get({[o]:{}}),i=e[o].domain;if(console.log("string todo:",t,s,o,[d.domain,i]),console.log("=== info: domain string ======",t,s,o),console.log("string:",t,s,o,d.domain),"string"==typeof e[o].domain)throw console.log("domain-string:",t,s,"const ",o,'={str:"'+i+'",domain:[]}'),"err";console.log("domain:",i)}const _=(i[o]||{}).fields;if(!_)continue;await r(e,t,d.relation,_)}}}let d=0;export{i as OdooJSAPI,o as get_odoojs_api};
