include: [ "docker-compose.include.yml" ]

services:
  dinky-mysql:
    image: mysql:8.0.39
    extends:
      file: docker-compose.extend.yml
      service: base
    networks:
      net:
        ipv4_address: ${DINKY_MYSQL_IP}
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    volumes:
      - ./apps/dinky-mysql/start.sh:/usr/local/bin/start.sh
      - ./apps/dinky-mysql/my.cnf:/etc/mysql/conf.d/my.cnf
      - ./apps/dinky-mysql/initdb.d:/docker-entrypoint-initdb.d
      - ${DATA}/dinky-mysql:/var/lib/mysql
      - ${LOGS}/dinky-mysql:/var/log/mysqld
    entrypoint: [ "/usr/local/bin/start.sh" ]
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
  dinky:
    image: dinkydocker/dinky-standalone-server:1.1.0-flink1.17
    extends:
      file: docker-compose.extend.yml
      service: base
    networks:
      net:
        ipv4_address: ${DINKY_IP}
    environment:
      - DB_ACTIVE=mysql
      - MYSQL_ADDR=dinky-mysql:3306
      - MYSQL_DATABASE=dinky
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD}
    ports:
      - 8888:8888
    volumes:
      - ./apps/dinky/extends/:/opt/dinky/customJar/
    command: bash -c "./auto.sh startOnPending"
    depends_on:
      dinky-mysql:
        condition: service_healthy
  flink-jobmanager:
    image: flink:1.17-scala_2.12-java8
    extends:
      file: docker-compose.extend.yml
      service: base
    networks:
      net:
        ipv4_address: ${FLINK_IP}
    environment:
      - JOB_MANAGER_RPC_ADDRESS=flink-jobmanager
    ports:
      - "8081:8081"
    command: jobmanager
    volumes:
      - ./apps/flink/lib/mysql-connector-java-8.0.30.jar:/opt/flink/lib/mysql-connector-java-8.0.30.jar
      - ./apps/dinky/extends/:/opt/flink/lib/customJar/
      - ./apps/dinky/flink-cdc:/flink-cdc
  flink-taskmanager:
    image: flink:1.17-scala_2.12-java8
    extends:
      file: docker-compose.extend.yml
      service: base
    networks:
      net:
        ipv4_address: ${FLINK_TASKMANAGER_IP}
    environment:
      - JOB_MANAGER_RPC_ADDRESS=flink-jobmanager
    command: taskmanager
    volumes:
      - ./apps/flink/lib/mysql-connector-java-8.0.30.jar:/opt/flink/lib/mysql-connector-java-8.0.30.jar
      - ./apps/dinky/extends/:/opt/flink/lib/customJar/
      - ./apps/dinky/flink-cdc:/flink-cdc
    depends_on:
      - flink-jobmanager
